import{getComponentValue as w,hasComponent as v,removeComponent as O,setComponent as x,updateComponent as _}from"@dojoengine/recs";import{Type as i}from"@dojoengine/recs";function y(e,o){return Object.keys(e).reduce((t,n)=>{let a=e[n],r=o[n];if(r===void 0)return t;if(r==null)return t[n]=r,t;if(r.type==="enum")if(r.type_name&&r.type_name.includes("Option")){if(r.value.option==="None")return t[n]=null,t;a=S(a),r=r.value.value}else return t[n]=r.value.option,t;switch(a){case i.StringArray:t[n]=h(r);break;case i.String:t[n]=r.value;break;case i.BigInt:t[n]=E(r.value);break;case i.Boolean:t[n]=r.value;break;case i.Number:t[n]=Number(r.value);break;default:t[n]=C(a,r);break}return t},{})}function S(e){switch(e){case i.OptionalNumber:return i.Number;case i.OptionalBigInt:return i.BigInt;case i.OptionalString:return i.String;case i.OptionalNumberArray:return i.NumberArray;case i.OptionalBigIntArray:return i.BigIntArray;case i.OptionalStringArray:return i.StringArray;case i.OptionalEntity:return i.Entity;case i.OptionalEntityArray:return i.EntityArray;case i.OptionalT:return i.T;default:return e}}function h(e){return e.type==="array"&&e.value.length===0?[]:e.type==="array"&&e.value[0]?.type==="enum"?e.value.map(o=>o.value.option):e.value.map(o=>{try{return BigInt(o.value)}catch{return o.value}})}function E(e){if(typeof e=="bigint")return e;try{return BigInt(e)}catch{console.warn(`Failed to convert ${e} to BigInt. Attempting hexadecimal conversion.`);try{return BigInt(`0x${e}`)}catch{return console.warn(`Failed to convert 0x${e} to BigInt. Using string value instead.`),e}}}function C(e,o){if(typeof e=="object"&&o.type==="struct")if(o.value instanceof Map){let t=Object.fromEntries(o.value);return y(e,t)}else return typeof o.value=="object"?y(e,o.value):(console.warn(`Expected value.value to be a Map or object for struct type, got ${typeof o.value}.`),o.value);return Array.isArray(e)&&o.type==="array"?o.value.map(t=>y(e[0],t)):o.value}var R=async(e,o,t,n=[],a=[],r=100,s=!1)=>(s&&console.log("Starting getSyncEntities ",t),await $(e,t,o,n,a,r,s),await B(e,o,t,s)),D=async(e,o,t,n=[],a=[],r=100,s=!1,l=!0,u)=>(s&&console.log("Starting getSyncEvents"),await j(e,o,n,a,r,t,s,l,u),await T(e,o,t,s)),$=async(e,o,t,n=[],a=[],r=100,s=!1,l=!1,{dbConnection:u,timestampCacheKey:f}={dbConnection:void 0,timestampCacheKey:""})=>{s&&console.log("Starting getEntities");let c,d=!0;for(;d;){let m=await e.getEntities({pagination:{limit:r,cursor:c,direction:"Forward",order_by:n},clause:o||void 0,no_hashed_keys:!1,models:a,historical:l,world_addresses:[]});u&&await g(u,m.items),s&&console.log("Fetched entities",m.items),p(m.items,t,s),Object.keys(m.items).length<r?d=!1:c=m.next_cursor}if(u){let m=Math.floor(Date.now()/1e3);M(m,f)}},j=async(e,o,t=[],n=[],a=100,r,s=!1,l=!1,u)=>{s&&console.log("Starting getEvents");let f,c=!0;for(;c;){let d=await e.getEventMessages({pagination:{limit:a,cursor:f,direction:"Forward",order_by:t},clause:r||void 0,no_hashed_keys:!1,models:n,historical:l,world_addresses:[]});if(s&&console.log("entities",d.items),p(d.items,o,s),d.items.length<a&&!d.next_cursor){c=!1;continue}Object.keys(d.items).length===0?(console.error("STOP FETCHING"),c=!1):(console.error("NEXT_CURSOR",d.next_cursor),f=d.next_cursor)}u&&u()},P=async(e,o,t,n=[],a=[],r=1e3,s=!1,l=!1)=>{s&&console.log("Starting getEntitiesQuery");let u,f=!0;for(;f;){let c=await e.getEntities({pagination:{limit:r,cursor:u,direction:"Forward",order_by:n},clause:t,no_hashed_keys:!1,models:a,historical:l,world_addresses:[]});if(s&&console.log(`Fetched ${Object.keys(c.items).length} entities ${c.next_cursor}`),p(c.items,o,s),c.items.length<r&&!c.next_cursor){f=!1;continue}Object.keys(c.items).length<r?f=!1:u=c.next_cursor}},B=async(e,o,t,n=!0)=>(n&&console.log("Starting syncEntities"),await e.onEntityUpdated(t,void 0,a=>{n&&console.log("Entity updated",a),p({[a.hashed_keys]:a},o,n)})),T=async(e,o,t,n=!1)=>(n&&console.log("Starting syncEvents"),await e.onEventMessageUpdated(t,void 0,(a,r)=>{n&&console.log("Event message updated",a),p({[a]:r},o,n)}));async function b(e,o,t,n){for(let a in o){if(!Object.hasOwn(o,a))continue;let r=Object.values(t).find(s=>`${s.metadata?.namespace}-${s.metadata?.name}`===a);if(!r){n&&console.warn(`Component ${a} not found in provided components for entity ${e}.`);continue}try{let s=o[a];if(s&&typeof s=="object"&&Object.keys(s).length===0){O(r,e,{skipUpdateStream:!1}),n&&console.log(`Removed component ${r.metadata?.name} on ${e}`);continue}n&&console.log(`Raw value for ${a} on ${e}:`,s);let l=y(r.schema,s);if(n&&console.log(`Converted value for ${a} on ${e}:`,l),l==null){console.error(`convertValues returned null or undefined for ${a} on ${e}. Raw value:`,s);continue}v(r,e)?(_(r,e,l,w(r,e)),n&&console.log(`Updated component ${r.metadata?.name} on ${e}`)):(x(r,e,l),n&&console.log(`Set component ${r.metadata?.name} on ${e}`))}catch(s){console.warn(`Failed to set component ${r.metadata?.name} on ${e}`,s)}}}var p=async(e,o,t=!1)=>{if(t&&console.log("Initial input to setEntities:",e),!e){t&&console.warn("Null or undefined input to setEntities.");return}if(Array.isArray(e)){if(e.length===0){t&&console.warn("Empty array passed to setEntities.");return}t&&console.log("Processing input as an array of ToriiEntity models.");for(let n of e)n&&typeof n.hashed_keys=="string"&&n.models&&typeof n.models=="object"?await b(n.hashed_keys,n.models,o,t):t&&console.warn("Skipping invalid entity model in array:",n)}else if(typeof e=="object"&&e!==null){if(Object.keys(e).length===0){t&&console.warn("Empty object passed to setEntities.");return}t&&console.log("Processing input as Record<EntityId, ComponentMap>.");for(let n in e)if(Object.hasOwn(e,n)){let a=e[n].models;typeof a=="object"&&a!==null?await b(n,a,o,t):t&&console.warn(`Data for entity ${n} is not a valid components map:`,a)}}else t&&console.warn("Invalid input type for setEntities:",e)},M=(e,o)=>{let t=Math.floor(e).toString();localStorage.setItem(o,t)};async function g(e,o){return new Promise((t,n)=>{let a=e.transaction(["entities"],"readwrite"),r=a.objectStore("entities"),s=0,l=null;a.oncomplete=()=>{l?n(l):t()},a.onerror=()=>{n(a.error)};for(let[u,f]of Object.entries(o)){let c={id:u,...f},d=r.put(c);s++,d.onerror=()=>{l=d.error}}})}export{R as a,D as b,$ as c,j as d,P as e,B as f,T as g,p as h};
//# sourceMappingURL=chunk-L4RXLPZT.js.map